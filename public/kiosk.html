<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Kiosk</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="./js/firebase-init.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #fffaf3;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 40px;
      text-align: center;
      width: 90%;
      max-width: 480px;
      transition: all 0.2s ease-in-out;
    }
    h1, h2 { color: #375a64; margin-bottom: 20px; }
    input[type="password"], input[type="text"] {
      padding: 12px 16px; font-size: 18px; border-radius: 12px;
      border: 1px solid #d8e2e6; width: 100%; text-align: center; margin-bottom: 10px;
    }
    button {
      background-color: #7aafbb; color: white; border: none; border-radius: 14px;
      padding: 14px 20px; font-size: 18px; cursor: pointer; width: 100%;
      transition: 0.2s ease;
    }
    button:hover { background-color: #6aa0ad; }
    .hidden { display: none; }

    .show-pin {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; font-size: 15px; color: #375a64; margin-bottom: 20px;
    }
    .show-pin input[type="checkbox"] {
      transform: scale(1.3);
      accent-color: #7aafbb;
      cursor: pointer;
    }

    #student-search {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
    #student-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 60vh;
      overflow-y: auto;
      position: relative;
    }
    .student-btn {
      background-color: #cce6eb;
      color: #375a64;
      font-weight: 600;
      padding: 20px;
      border-radius: 16px;
      font-size: 20px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      position: relative;
      overflow: visible; /* allows confetti outside */
    }
    .student-btn:active { transform: scale(0.97); }
    .student-btn.checked-in {
      background-color: #a4d4ae;
      color: #2c5530;
    }
    .logout-btn {
      background-color: #f5b7b1;
      color: #fff;
      margin-top: 25px;
    }
    .logout-btn:hover { background-color: #ec7063; }

    /* Confetti */
    .confetti {
      position: absolute;
      width: 8px; height: 8px;
      border-radius: 50%;
      opacity: 0.9;
      animation: fall 1.6s ease-out forwards;
    }
    @keyframes fall {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(70px) scale(0.4); opacity: 0; }
    }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      color: #2a3b44;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 0.95em;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .toast--show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>

<body>
  <div id="login-card" class="card">
    <h1>Welcome</h1>
    <h2>Enter PIN to Start</h2>
    <input type="password" id="pin-input" placeholder="Enter PIN" maxlength="6" />
    <div class="show-pin">
      <input type="checkbox" id="toggle-pin" />
      <label for="toggle-pin">Show PIN</label>
    </div>
    <button id="pin-submit">Unlock</button>
    <p id="pin-error" style="color:#d9534f; display:none; margin-top:10px;">Incorrect PIN. Try again.</p>
  </div>

  <div id="kiosk-card" class="card hidden">
    <h1>Check In / Check Out</h1>
    <input type="text" id="student-search" placeholder="Search student..." />
    <div id="student-list"><p style="color:#7f8c8d;">Loading students...</p></div>
    <button class="logout-btn" id="logout-btn">Logout</button>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const db = firebase.firestore();
    const loginCard = document.getElementById("login-card");
    const kioskCard = document.getElementById("kiosk-card");
    const pinInput = document.getElementById("pin-input");
    const pinSubmit = document.getElementById("pin-submit");
    const pinError = document.getElementById("pin-error");
    const togglePin = document.getElementById("toggle-pin");
    const logoutBtn = document.getElementById("logout-btn");
    const studentList = document.getElementById("student-list");
    const searchInput = document.getElementById("student-search");
    const toast = document.getElementById("toast");

    let currentUID = null;
    let unsubscribe = null;
    let allStudents = [];

    // Toast
    function showToast(text) {
      toast.textContent = text;
      toast.classList.add("toast--show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove("toast--show"), 1800);
    }

    // Confetti Burst (soft circular)
    function confettiBurst(btn) {
      const colors = ["#a4d4ae", "#b3e5c3", "#8ccf9a", "#d2f5dc", "#a8e2b4"];
      for (let i = 0; i < 20; i++) {
        const conf = document.createElement("div");
        conf.className = "confetti";
        conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        const angle = Math.random() * 2 * Math.PI;
        const radius = 25 + Math.random() * 15;
        const x = 50 + Math.cos(angle) * radius;
        const y = 50 + Math.sin(angle) * radius;
        conf.style.left = `${x}%`;
        conf.style.top = `${y}%`;
        btn.appendChild(conf);
        setTimeout(() => conf.remove(), 1600);
      }
    }

    togglePin.addEventListener("change", () => {
      pinInput.type = togglePin.checked ? "text" : "password";
    });

    // PIN unlock
    pinSubmit.addEventListener("click", async () => {
      const enteredPin = pinInput.value.trim();
      if (!enteredPin) return;
      pinError.style.display = "none";
      studentList.innerHTML = "<p style='color:#7f8c8d;'>Loading students...</p>";
      try {
        const usersSnap = await db.collection("users").get();
        let foundUID = null;
        for (const doc of usersSnap.docs) {
          const pinDoc = await db.collection("users").doc(doc.id).collection("staffPins").doc(enteredPin).get();
          if (pinDoc.exists) { foundUID = doc.id; break; }
        }
        if (foundUID) {
          currentUID = foundUID;
          loginCard.classList.add("hidden");
          kioskCard.classList.remove("hidden");
          loadStudents(foundUID);
        } else pinError.style.display = "block";
      } catch (e) { console.error(e); pinError.style.display = "block"; }
      pinInput.value = "";
      togglePin.checked = false;
      pinInput.type = "password";
    });

    // Real-time sync
    function loadStudents(uid) {
      if (unsubscribe) unsubscribe();
      unsubscribe = db.collection("users").doc(uid).collection("students")
        .onSnapshot(snapshot => {
          allStudents = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          renderStudents(allStudents);
        });
    }

    // Render Students
    function renderStudents(students) {
      const filter = searchInput.value.trim().toLowerCase();
      const filtered = filter ? students.filter(s => (s.name || "").toLowerCase().includes(filter)) : students;
      studentList.innerHTML = filtered.length ? "" : "<p style='color:#7f8c8d;'>No students found.</p>";
      filtered.forEach(student => {
        const btn = document.createElement("button");
        btn.textContent = student.name || "Unnamed";
        btn.className = "student-btn" + (student.status === "checkedIn" ? " checked-in" : "");
        btn.onclick = async () => {
          const latestSnap = await db.collection("users").doc(currentUID).collection("students").doc(student.id).get();
          const latestData = latestSnap.data();
          await toggleCheckInOut({ ...latestData, id: student.id }, btn);
          setTimeout(() => { searchInput.value = ""; renderStudents(allStudents); }, 1500);
        };
        studentList.appendChild(btn);
      });
    }

    searchInput.addEventListener("input", () => renderStudents(allStudents));

    // Check In/Out
    async function toggleCheckInOut(student, btn) {
      if (!currentUID) return;
      const ref = db.collection("users").doc(currentUID).collection("students").doc(student.id);
      const sessionsRef = ref.collection("sessions");
      const ts = firebase.firestore.Timestamp.fromDate(new Date());
      try {
        if (student.status === "checkedIn") {
          await ref.update({ status: "checkedOut", checkInTime: null });
          const recent = await sessionsRef.orderBy("checkInTime", "desc").limit(1).get();
          const open = recent.docs.find(d => !d.data().checkOutTime);
          if (open) await open.ref.update({ checkOutTime: ts });
          showToast(`${student.name} checked out ðŸ‘‹`);
        } else {
          await ref.update({ status: "checkedIn", checkInTime: ts });
          await sessionsRef.add({ checkInTime: ts, checkOutTime: null });
          confettiBurst(btn);
          showToast(`${student.name} checked in âœ…`);
        }
      } catch (e) { console.error(e); }
    }

    // Logout
    logoutBtn.addEventListener("click", () => {
      if (unsubscribe) unsubscribe();
      currentUID = null;
      loginCard.classList.remove("hidden");
      kioskCard.classList.add("hidden");
      studentList.innerHTML = "<p style='color:#7f8c8d;'>Loading students...</p>";
    });
  </script>
</body>
</html>

